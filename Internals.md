# Internal Architecture & Developer Guide

This document provides a technical overview of the components and design choices for the MediaWiki Docker setup. It is intended for developers who may need to maintain, extend, or debug the project.

## Core Docker Concepts

-   **Image:** A read-only blueprint for a container (e.g., `mediawiki:1.43-fpm`).
-   **Container:** A live, running instance of an image. Our setup runs the MediaWiki application, a database, and a web server in separate, isolated containers.
-   **Docker Compose:** A tool for defining and running multi-container applications. The `docker-compose.yml` file is our master plan that tells Docker Compose how to connect our containers.
-   **Volume:** A mechanism for persisting data generated by and used by Docker containers. We use volumes to ensure our database and configuration are not lost when containers are stopped or removed.

---

## Service Architecture

The environment is orchestrated using Docker Compose and consists of four main services defined in `docker-compose.yml`.

### 1. `mariadb`

-   **Image:** `mariadb:10.6`
-   **Purpose:** Provides the SQL database for MediaWiki.
-   **Persistence:** The entire MariaDB data directory (`/var/lib/mysql`) is mapped to a persistent named volume (`db_data`).
-   **Configuration:** Database name, user, and passwords are all configured via environment variables passed from the `.env` file.
-   **Healthcheck:** A `healthcheck` is included to ensure that other services don't start until the database is ready to accept connections.

### 2. `mw-install` (Transient Installer)

-   **Image:** `mediawiki:1.43-fpm`
-   **Purpose:** A temporary container whose only job is to perform the initial installation and configuration of MediaWiki.
-   **Logic:**
    1.  Starts only after the `mariadb` container is healthy.
    2.  Checks for the existence of `LocalSettings.php` in the persistent `./mnt/config` directory.
    3.  If the file does not exist, it runs the `maintenance/install.php` command-line installer, using the credentials from the `.env` file.
    4.  Upon success, it places the generated `LocalSettings.php` into the `./mnt/config` directory for the main application to use.
-   **Lifecycle:** This container runs once during the `--init` process and then exits. It does not run during normal operation.

### 3. `mediawiki` (Application)

-   **Image:** `mediawiki:1.43-fpm`
-   **Purpose:** The main application container that runs the PHP-FPM process to execute the MediaWiki code.
-   **Dependencies:** It waits for the `mw-install` container to complete successfully, ensuring that `LocalSettings.php` is present before it starts.
-   **Configuration:** It copies the `LocalSettings.php` from the persistent volume into the correct location within the container before starting the PHP-FPM process.
-   **Networking:** It is not exposed to the public internet. It only listens for FastCGI requests from the `nginx` service on its internal network.

### 4. `nginx` (Web Server)

-   **Image:** `nginx:latest`
-   **Purpose:** Acts as the public-facing web server and reverse proxy.
-   **Responsibilities:**
    1.  Listens on the public port defined by `HOST_PORT` in the `.env` file.
    2.  Serves static files (CSS, JS, images) directly for high performance.
    3.  Forwards any requests for PHP pages to the `mediawiki` service via FastCGI (`fastcgi_pass mediawiki:9000;`).
-   **Configuration:** The `nginx.conf` file is mounted directly from the host, allowing for easy customization without rebuilding the image.

---

## How the Containers Work Together

1.  A user sends a request to `http://localhost:8080` (or the configured host port).
2.  Docker forwards this request from the host machine to the **Nginx container** on port 80.
3.  Nginx looks at the request. If it's for a PHP page, it passes the request to the **MediaWiki container** using its service name (`mediawiki:9000`) over the private Docker network.
4.  The **MediaWiki container** (running PHP-FPM) executes the MediaWiki code.
5.  If the MediaWiki code needs to access the database, it connects to the **MariaDB container** using its service name (`mariadb`) over the private network.
6.  The response travels back through the same chain to the user's browser.

### The Private Network

By default, Docker Compose creates a private virtual network for the application. All containers defined in the `docker-compose.yml` file are attached to this network.

This is what allows the containers to communicate with each other using their service names as hostnames (e.g., `mediawiki`, `mariadb`). Docker's internal DNS resolves these names to the correct container's private IP address.

This provides a significant security benefit: **the database and application containers do not need to expose any ports to the host machine or the outside world.** The only public entry point is the Nginx container.

---

## Data Persistence and State

A key design principle of this environment is that it is **stateful**. Your work is not lost when you stop the containers. This is achieved through a combination of Docker Named Volumes and Host Bind Mounts.

-   **Named Volumes (`db_data`, `mediawiki_code`):** These are the preferred Docker method for storing persistent data. Docker manages these volumes on the host filesystem. They store the entire MariaDB database and the MediaWiki application code.
-   **Host Bind Mounts (`./mnt`):** We use a bind mount for the `./mnt` directory to provide easy, direct access to critical files from the host machine. This is particularly useful for:
    -   `./mnt/config`: Storing the `LocalSettings.php` file.
    -   `./mnt/db`: While the primary data is in a named volume, this structure was kept for potential direct database access or backup scenarios.

This hybrid approach provides both the robustness of named volumes and the convenience of bind mounts for specific configuration files.